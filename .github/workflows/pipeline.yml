name: Deploy Fullstack App

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      # Provide the base API URL to the frontend build via env var. Set this secret in your repo: BASE_API_URL
      REACT_APP_BASE_API_URL: ${{ secrets.BASE_API_URL }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build frontend
        run: |
          # if your frontend is in a subfolder 'client' change to that directory
          npm ci
          npm run build

      - name: Install backend (if any)
        run: |
          # if you have a 'server' folder use the below lines (no-op if not present)
          if [ -d server ]; then
            cd server
            npm ci
          fi

      - name: Deploy to EC2 (copy files)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          # copy the build directory and server (if exists) and env files
          source: "build/*,server/*,server/.*,.env*"
          target: "~/app"
          overwrite: true
          strip_components: 0

      - name: Restart app on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -e
            cd ~/app || exit 0
            # move .env into server if present
            [ -f .env ] && [ -d server ] && mv .env server/ || true
            # install production deps for backend if present
            if [ -d server ]; then
              cd server
              npm ci --production
              # try restarting with pm2, otherwise start the server (adjust entry if needed)
              pm2 restart app || pm2 start dist/index.js --name app || pm2 start src/server.ts --name app --interpreter tsx || true
            fi
            # Copy frontend static build to nginx/www root if desired
            if [ -d ../build ]; then
              sudo cp -r ../build/* /var/www/html/ || true
            elif [ -d ../client/dist ]; then
              sudo cp -r ../client/dist/* /var/www/html/ || true
            fi
